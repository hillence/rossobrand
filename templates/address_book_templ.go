// Code generated by templ - DO NOT EDIT.

// templ: version: v0.3.960
package templates

//lint:file-ignore SA4006 This context is only used if a nested component is present.

import "github.com/a-h/templ"
import templruntime "github.com/a-h/templ/runtime"

import (
	"fmt"
	"gogo/database"
	"strings"
)

func AddressBook(isAuthenticated bool, addresses []*database.UserSavedAddress, redirectAfterSave bool) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var1 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var1 == nil {
			templ_7745c5c3_Var1 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 1, "<html><head><title>Адреса доставки</title><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"><link rel=\"stylesheet\" href=\"/static/style.css\"><script src=\"/static/htmx.min.js\"></script></head><body>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = Header(isAuthenticated, false).Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 2, "<main class=\"address-book\" data-address-redirect=\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var2 string
		templ_7745c5c3_Var2, templ_7745c5c3_Err = templ.JoinStringErrs(fmt.Sprintf("%t", redirectAfterSave))
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/address_book.templ`, Line: 20, Col: 99}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var2))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 3, "\"><div class=\"container\"><section class=\"address-book__section\"><header class=\"address-book__header\"><h1 class=\"address-book__title\">Адреса доставки</h1><p class=\"address-book__subtitle\">Добавьте адрес, чтобы оформить доставку.</p></header><div class=\"address-book__list\" data-address-list><p class=\"address-book__empty\" data-address-empty style=\"")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		var templ_7745c5c3_Var3 string
		templ_7745c5c3_Var3, templ_7745c5c3_Err = templruntime.SanitizeStyleAttributeValues(map[bool]string{true: "", false: "display:none;"}[len(addresses) == 0])
		if templ_7745c5c3_Err != nil {
			return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/address_book.templ`, Line: 28, Col: 156}
		}
		_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var3))
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 4, "\">Адреса пока не добавлены.</p>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		for _, item := range addresses {
			if item != nil {
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 5, "<div class=\"address-card\" data-address-item data-address-id=\"")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				var templ_7745c5c3_Var4 string
				templ_7745c5c3_Var4, templ_7745c5c3_Err = templ.JoinStringErrs(fmt.Sprintf("%d", item.ID))
				if templ_7745c5c3_Err != nil {
					return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/address_book.templ`, Line: 31, Col: 124}
				}
				_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var4))
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 6, "\" data-address-value=\"")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				var templ_7745c5c3_Var5 string
				templ_7745c5c3_Var5, templ_7745c5c3_Err = templ.JoinStringErrs(strings.TrimSpace(item.Address))
				if templ_7745c5c3_Err != nil {
					return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/address_book.templ`, Line: 31, Col: 179}
				}
				_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var5))
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 7, "\"><button type=\"button\" class=\"address-card__select\" data-address-select>")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				var templ_7745c5c3_Var6 string
				templ_7745c5c3_Var6, templ_7745c5c3_Err = templ.JoinStringErrs(strings.TrimSpace(item.Address))
				if templ_7745c5c3_Err != nil {
					return templ.Error{Err: templ_7745c5c3_Err, FileName: `templates/address_book.templ`, Line: 32, Col: 144}
				}
				_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var6))
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
				templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 8, "</button> <button type=\"button\" class=\"address-card__delete\" data-address-delete aria-label=\"Удалить адрес\"><span>Удалить</span></button></div>")
				if templ_7745c5c3_Err != nil {
					return templ_7745c5c3_Err
				}
			}
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 9, "</div><div class=\"address-book__actions\"><button type=\"button\" class=\"address-book__add\" data-address-add><span class=\"address-book__add-icon\">+</span> <span>Добавить новый адрес</span></button></div><div class=\"address-book__map\" data-address-map-container hidden><div class=\"address-map\" data-address-map-shell><div class=\"address-map__search-toggle\"><button type=\"button\" class=\"address-map__search-trigger\" data-address-search-toggle>Введите адрес</button></div><p class=\"address-map__selection is-muted\" data-address-selection>Перемещайте карту, чтобы выбрать адрес.</p><div class=\"address-map__shell\"><div class=\"address-map__canvas\" id=\"address-map\" role=\"presentation\" data-address-map-canvas></div><div class=\"address-map__marker\" data-address-marker aria-hidden=\"true\"><span class=\"address-map__marker-outer\"><span class=\"address-map__marker-inner\"></span></span> <span class=\"address-map__marker-stem\"></span> <span class=\"address-map__marker-shadow\"></span></div><button type=\"button\" class=\"address-map__geo\" data-address-geo aria-label=\"Определить текущее местоположение\"><span class=\"visually-hidden\">Определить текущее местоположение</span> <span class=\"address-map__geo-icon\" aria-hidden=\"true\"></span></button></div><div class=\"address-map__footer\"><button type=\"button\" class=\"address-map__save\" data-address-save disabled>Сохранить адрес</button></div><div class=\"address-map__search-panel\" data-address-search-panel hidden><div class=\"address-map__search-content\"><input type=\"text\" class=\"address-map__search-input\" placeholder=\"Например, Москва, Тверская 7\" data-address-input><div class=\"address-map__results\" data-address-results></div><button type=\"button\" class=\"address-map__search-close\" data-address-search-close>Показать</button></div></div></div></div></section></div></main>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = Banner().Render(ctx, templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 10, "<script>\n                (function () {\n                    var doc = document;\n                    var root = doc.querySelector('.address-book');\n                    if (!root) { return; }\n\n                    var redirectAfterSave = root.getAttribute('data-address-redirect') === 'true';\n                    var addButton = root.querySelector('[data-address-add]');\n                    var mapWrapper = root.querySelector('[data-address-map-container]');\n                    var mapShell = root.querySelector('[data-address-map-shell]');\n                    var mapCanvas = root.querySelector('[data-address-map-canvas]');\n                    var markerElement = root.querySelector('[data-address-marker]');\n                    var saveButton = root.querySelector('[data-address-save]');\n                    var selectionText = root.querySelector('[data-address-selection]');\n                    var searchToggle = root.querySelector('[data-address-search-toggle]');\n                    var searchPanel = root.querySelector('[data-address-search-panel]');\n                    var searchInput = root.querySelector('[data-address-input]');\n                    var resultsBox = root.querySelector('[data-address-results]');\n                    var searchClose = root.querySelector('[data-address-search-close]');\n                    var geoButton = root.querySelector('[data-address-geo]');\n                    var listContainer = root.querySelector('[data-address-list]');\n                    var emptyState = root.querySelector('[data-address-empty]');\n\n                    var yandexApiKey = '5d0f0a04-cea3-40ff-940e-5a97428fad05';\n                    var scriptLoaded = false;\n                    var mapInitialized = false;\n                    var mapOpened = false;\n                    var mapInstance = null;\n                    var markerLandingTimer = null;\n                    var centerUpdateTimer = null;\n                    var lastFetchedKey = '';\n                    var debounceTimer = null;\n                    var geoBusy = false;\n                    var pendingGeo = false;\n                    var selectedAddressValue = '';\n                    var selectedCoordinates = null;\n\n                    function toggleEmptyState() {\n                        if (!emptyState || !listContainer) { return; }\n                        var hasItems = listContainer.querySelector('[data-address-item]') !== null;\n                        if (hasItems) {\n                            emptyState.style.display = 'none';\n                        } else {\n                            emptyState.style.display = '';\n                        }\n                    }\n\n                    toggleEmptyState();\n\n                    if (addButton) {\n                        addButton.addEventListener('click', function () {\n                            showMap();\n                        });\n                    }\n\n                    function showMap() {\n                        if (!mapWrapper) { return; }\n                        if (mapOpened) { return; }\n                        mapOpened = true;\n                        mapWrapper.hidden = false;\n                        mapWrapper.classList.add('is-open');\n                        if (saveButton) {\n                            saveButton.textContent = 'Сохранить адрес';\n                            saveButton.disabled = true;\n                        }\n                        updateSelection('');\n                        updateSaveState();\n                        if (!scriptLoaded) {\n                            loadScript(initMap);\n                        } else {\n                            initMap();\n                        }\n                    }\n\n                    function hideMap() {\n                        if (!mapWrapper) { return; }\n                        mapOpened = false;\n                        mapWrapper.hidden = true;\n                        mapWrapper.classList.remove('is-open');\n                    }\n\n                    function updateSelection(text) {\n                        if (!selectionText) { return; }\n                        if (text) {\n                            selectionText.textContent = 'Выбранный адрес: ' + text;\n                            selectionText.classList.remove('is-muted');\n                        } else {\n                            selectionText.textContent = 'Перемещайте карту, чтобы выбрать адрес.';\n                            selectionText.classList.add('is-muted');\n                        }\n                    }\n\n                    function updateSaveState() {\n                        if (!saveButton) { return; }\n                        saveButton.disabled = !selectedAddressValue;\n                    }\n\n                    function loadScript(callback) {\n                        if (scriptLoaded) {\n                            if (typeof callback === 'function') {\n                                callback();\n                            }\n                            return;\n                        }\n                        var script = doc.createElement('script');\n                        script.src = 'https://api-maps.yandex.ru/2.1/?apikey=' + yandexApiKey + '&lang=ru_RU';\n                        script.onload = function () {\n                            scriptLoaded = true;\n                            if (window.ymaps) {\n                                window.ymaps.ready(callback);\n                            }\n                        };\n                        script.onerror = function () {\n                            updateSelection('Не удалось загрузить карту. Попробуйте обновить страницу.');\n                        };\n                        doc.head.appendChild(script);\n                    }\n\n                    function initMap() {\n                        if (!mapCanvas) { return; }\n                        if (mapInitialized) {\n                            if (mapInstance && mapInstance.container) {\n                                mapInstance.container.fitToViewport();\n                            }\n                            return;\n                        }\n                        if (!window.ymaps) { return; }\n                        mapInitialized = true;\n                        mapInstance = new window.ymaps.Map(mapCanvas, {\n                            center: [55.751244, 37.618423],\n                            zoom: 10,\n                            controls: []\n                        }, {\n                            suppressMapOpenBlock: true,\n                            suppressObsoleteBrowserNotifier: true,\n                            yandexMapDisablePoiInteractivity: true\n                        });\n\n                        mapInstance.events.add('actionbegin', function () {\n                            liftMarker();\n                        });\n                        mapInstance.events.add('actionend', function () {\n                            handleCenterChange();\n                        });\n\n                        handleCenterChange();\n                    }\n\n                    function liftMarker() {\n                        if (!markerElement) { return; }\n                        markerElement.classList.remove('address-map__marker--landing');\n                        markerElement.classList.add('address-map__marker--lifted');\n                        if (markerLandingTimer) {\n                            clearTimeout(markerLandingTimer);\n                            markerLandingTimer = null;\n                        }\n                    }\n\n                    function landMarker() {\n                        if (!markerElement) { return; }\n                        markerElement.classList.remove('address-map__marker--lifted');\n                        markerElement.classList.add('address-map__marker--landing');\n                        if (markerLandingTimer) {\n                            clearTimeout(markerLandingTimer);\n                        }\n                        markerLandingTimer = setTimeout(function () {\n                            markerElement.classList.remove('address-map__marker--landing');\n                            markerLandingTimer = null;\n                        }, 420);\n                    }\n\n                    function handleCenterChange() {\n                        if (!mapInstance) { return; }\n                        if (centerUpdateTimer) {\n                            clearTimeout(centerUpdateTimer);\n                        }\n                        centerUpdateTimer = setTimeout(function () {\n                            var coords = mapInstance.getCenter();\n                            if (!coords || coords.length !== 2) { return; }\n                            var key = coords[0].toFixed(6) + ',' + coords[1].toFixed(6);\n                            if (key === lastFetchedKey) { return; }\n                            lastFetchedKey = key;\n                            fetchAddress(coords);\n                        }, 250);\n                    }\n\n                    function fetchAddress(coords) {\n                        if (!coords || coords.length !== 2) { return; }\n                        var geocodeUrl = 'https://geocode-maps.yandex.ru/1.x/?format=json&apikey=' + yandexApiKey + '&geocode=' + coords[1] + ',' + coords[0];\n                        selectedAddressValue = '';\n                        selectedCoordinates = null;\n                        updateSaveState();\n                        updateSelection('Определяем адрес...');\n                        landMarker();\n\n                        fetch(geocodeUrl)\n                            .then(function (response) {\n                                if (!response.ok) {\n                                    throw new Error('geocode failed');\n                                }\n                                return response.json();\n                            })\n                            .then(function (data) {\n                                var members = data && data.response && data.response.GeoObjectCollection && data.response.GeoObjectCollection.featureMember;\n                                if (members && members.length) {\n                                    var meta = members[0].GeoObject && members[0].GeoObject.metaDataProperty && members[0].GeoObject.metaDataProperty.GeocoderMetaData;\n                                    var address = meta && meta.text ? meta.text : '';\n                                    if (address) {\n                                        selectedAddressValue = address;\n                                        selectedCoordinates = coords;\n                                        updateSelection(address);\n                                        updateSaveState();\n                                        return;\n                                    }\n                                }\n                                updateSelection('Не удалось определить адрес. Попробуйте переместить карту.');\n                            })\n                            .catch(function () {\n                                updateSelection('Не удалось определить адрес. Попробуйте снова.');\n                            });\n                    }\n\n                    function showSearchPanel() {\n                        if (!searchPanel) { return; }\n                        searchPanel.hidden = false;\n                        searchPanel.classList.add('is-open');\n                        if (searchInput) {\n                            searchInput.value = '';\n                            searchInput.focus();\n                        }\n                        if (resultsBox) {\n                            resultsBox.innerHTML = '';\n                        }\n                    }\n\n                    function hideSearchPanel() {\n                        if (!searchPanel) { return; }\n                        searchPanel.hidden = true;\n                        searchPanel.classList.remove('is-open');\n                    }\n\n                    function renderSearchResults(items) {\n                        if (!resultsBox) { return; }\n                        resultsBox.innerHTML = '';\n                        if (!items || !items.length) {\n                            var empty = doc.createElement('div');\n                            empty.className = 'address-map__result-empty';\n                            empty.textContent = 'Ничего не найдено';\n                            resultsBox.appendChild(empty);\n                            return;\n                        }\n                        for (var i = 0; i < items.length && i < 10; i += 1) {\n                            var item = items[i];\n                            var button = doc.createElement('button');\n                            button.type = 'button';\n                            button.className = 'address-map__result-item';\n                            button.dataset.lat = String(item.lat);\n                            button.dataset.lon = String(item.lon);\n                            button.textContent = item.text;\n                            resultsBox.appendChild(button);\n                        }\n                    }\n\n                    function geocodeQuery(query) {\n                        if (!query) { return; }\n                        var url = 'https://geocode-maps.yandex.ru/1.x/?format=json&apikey=' + yandexApiKey + '&geocode=' + encodeURIComponent(query);\n                        renderSearchResults([{ text: 'Ищем адрес...', lat: 0, lon: 0, isPlaceholder: true }]);\n\n                        fetch(url)\n                            .then(function (response) {\n                                if (!response.ok) {\n                                    throw new Error('geocode failed');\n                                }\n                                return response.json();\n                            })\n                            .then(function (data) {\n                                var members = data && data.response && data.response.GeoObjectCollection && data.response.GeoObjectCollection.featureMember;\n                                if (!members || !members.length) {\n                                    renderSearchResults([]);\n                                    return;\n                                }\n                                var results = [];\n                                for (var i = 0; i < members.length; i += 1) {\n                                    var geo = members[i].GeoObject;\n                                    if (!geo || !geo.Point || !geo.Point.pos) { continue; }\n                                    var pos = String(geo.Point.pos).split(' ');\n                                    if (pos.length !== 2) { continue; }\n                                    var text = '';\n                                    if (geo.metaDataProperty && geo.metaDataProperty.GeocoderMetaData) {\n                                        text = geo.metaDataProperty.GeocoderMetaData.text || '';\n                                    }\n                                    if (!text && geo.name) {\n                                        text = geo.name;\n                                    }\n                                    results.push({\n                                        text: text,\n                                        lon: parseFloat(pos[0]),\n                                        lat: parseFloat(pos[1])\n                                    });\n                                }\n                                renderSearchResults(results);\n                            })\n                            .catch(function () {\n                                renderSearchResults([]);\n                            });\n                    }\n\n                    if (searchToggle) {\n                        searchToggle.addEventListener('click', function () {\n                            showSearchPanel();\n                        });\n                    }\n\n                    if (searchClose) {\n                        searchClose.addEventListener('click', function () {\n                            hideSearchPanel();\n                        });\n                    }\n\n                    if (searchInput) {\n                        searchInput.addEventListener('input', function () {\n                            var value = searchInput.value.trim();\n                            if (debounceTimer) {\n                                clearTimeout(debounceTimer);\n                            }\n                            debounceTimer = setTimeout(function () {\n                                if (value.length >= 3) {\n                                    geocodeQuery(value);\n                                } else {\n                                    if (resultsBox) {\n                                        resultsBox.innerHTML = '';\n                                    }\n                                }\n                            }, 300);\n                        });\n                        searchInput.addEventListener('keydown', function (event) {\n                            if (event.key === 'Enter') {\n                                event.preventDefault();\n                                var value = searchInput.value.trim();\n                                if (value.length >= 3) {\n                                    geocodeQuery(value);\n                                }\n                            } else if (event.key === 'Escape') {\n                                hideSearchPanel();\n                            }\n                        });\n                    }\n\n                    if (resultsBox) {\n                        resultsBox.addEventListener('click', function (event) {\n                            var target = event.target;\n                            if (!(target instanceof Element)) { return; }\n                            if (!target.classList.contains('address-map__result-item')) { return; }\n                            if (!mapInstance) { return; }\n\n                            var lat = parseFloat(target.dataset.lat);\n                            var lon = parseFloat(target.dataset.lon);\n                            if (isNaN(lat) || isNaN(lon)) { return; }\n                            lastFetchedKey = '';\n                            mapInstance.setCenter([lat, lon], Math.max(mapInstance.getZoom(), 15));\n                            hideSearchPanel();\n                        });\n                    }\n\n                    function handleGeoRequest() {\n                        if (!window.ymaps || !mapInstance) { return; }\n                        if (geoBusy) { return; }\n                        geoBusy = true;\n                        if (geoButton) {\n                            geoButton.classList.add('is-loading');\n                        }\n                        window.ymaps.geolocation.get({\n                            provider: 'browser',\n                            autoReverseGeocode: true\n                        }).then(function (result) {\n                            var coords = null;\n                            if (result && result.geoObjects) {\n                                if (typeof result.geoObjects.position !== 'undefined') {\n                                    coords = result.geoObjects.position;\n                                } else if (result.geoObjects.get(0)) {\n                                    coords = result.geoObjects.get(0).geometry.getCoordinates();\n                                }\n                            }\n                            if (coords && coords.length === 2) {\n                                lastFetchedKey = '';\n                                mapInstance.setCenter(coords, Math.max(mapInstance.getZoom(), 15));\n                            } else {\n                                updateSelection('Не удалось определить местоположение. Введите адрес вручную.');\n                            }\n                        }).catch(function () {\n                            updateSelection('Не удалось определить местоположение. Введите адрес вручную.');\n                        }).finally(function () {\n                            geoBusy = false;\n                            if (geoButton) {\n                                geoButton.classList.remove('is-loading');\n                            }\n                        });\n                    }\n\n                    if (geoButton) {\n                        geoButton.addEventListener('click', function () {\n                            if (!mapInitialized) {\n                                showMap();\n                            }\n                            handleGeoRequest();\n                        });\n                    }\n\n                    if (saveButton) {\n                        saveButton.addEventListener('click', function () {\n                            if (!selectedAddressValue) { return; }\n                            saveButton.disabled = true;\n                            saveButton.textContent = 'Сохраняем...';\n\n                            fetch('/address-book/save', {\n                                method: 'POST',\n                                headers: {\n                                    'Content-Type': 'application/json'\n                                },\n                                body: JSON.stringify({ address: selectedAddressValue })\n                            }).then(function (response) {\n                                if (!response.ok) {\n                                    throw new Error('save failed');\n                                }\n                                return response.json();\n                            }).then(function (payload) {\n                                saveButton.textContent = 'Сохранить адрес';\n                                selectedAddressValue = '';\n                                selectedCoordinates = null;\n                                updateSaveState();\n                                if (payload && payload.address && payload.id) {\n                                    appendAddressCard({\n                                        id: payload.id,\n                                        address: payload.address\n                                    });\n                                }\n                                if (redirectAfterSave) {\n                                    window.location.href = '/simplecheckout';\n                                } else {\n                                    saveButton.disabled = true;\n                                    updateSelection('');\n                                    hideMap();\n                                }\n                            }).catch(function () {\n                                saveButton.disabled = false;\n                                saveButton.textContent = 'Сохранить адрес';\n                                window.alert('Не удалось сохранить адрес. Попробуйте снова.');\n                            });\n                        });\n                    }\n\n                    function appendAddressCard(data) {\n                        if (!data || !listContainer) { return; }\n                        var card = doc.createElement('div');\n                        card.className = 'address-card';\n                        card.setAttribute('data-address-item', '');\n                        card.setAttribute('data-address-id', String(data.id));\n                        card.setAttribute('data-address-value', data.address || '');\n\n                        var selectButton = doc.createElement('button');\n                        selectButton.type = 'button';\n                        selectButton.className = 'address-card__select';\n                        selectButton.setAttribute('data-address-select', '');\n                        selectButton.textContent = data.address || '';\n\n                        var deleteButton = doc.createElement('button');\n                        deleteButton.type = 'button';\n                        deleteButton.className = 'address-card__delete';\n                        deleteButton.setAttribute('data-address-delete', '');\n                        deleteButton.setAttribute('aria-label', 'Удалить адрес');\n                        deleteButton.innerHTML = '<span>Удалить</span>';\n\n                        card.appendChild(selectButton);\n                        card.appendChild(deleteButton);\n                        listContainer.prepend(card);\n                        toggleEmptyState();\n                    }\n\n                    if (listContainer) {\n                        listContainer.addEventListener('click', function (event) {\n                            var target = event.target;\n                            if (!(target instanceof Element)) { return; }\n                            var select = target.closest('[data-address-select]');\n                            if (select) {\n                                var wrapper = select.closest('[data-address-item]');\n                                if (!wrapper) { return; }\n                                var id = wrapper.getAttribute('data-address-id');\n                                if (!id) { return; }\n                                selectStoredAddress(wrapper, id);\n                                return;\n                            }\n                            var deleteBtn = target.closest('[data-address-delete]');\n                            if (!deleteBtn) { return; }\n                            var card = deleteBtn.closest('[data-address-item]');\n                            if (!card) { return; }\n                            var id = card.getAttribute('data-address-id');\n                            if (!id) { return; }\n\n                            deleteBtn.disabled = true;\n\n                            fetch('/address-book/' + encodeURIComponent(id), {\n                                method: 'DELETE'\n                            }).then(function (response) {\n                                if (!response.ok && response.status !== 404) {\n                                    throw new Error('delete failed');\n                                }\n                                card.remove();\n                                toggleEmptyState();\n                            }).catch(function () {\n                                deleteBtn.disabled = false;\n                                window.alert('Не удалось удалить адрес. Попробуйте снова.');\n                            });\n                        });\n                    }\n\n                    function selectStoredAddress(card, id) {\n                        if (!card || !id) { return; }\n                        card.classList.add('address-card--active');\n                        fetch('/address-book/select', {\n                            method: 'POST',\n                            headers: {\n                                'Content-Type': 'application/json'\n                            },\n                            body: JSON.stringify({ address_id: parseInt(id, 10) || 0 })\n                        }).then(function (response) {\n                            if (!response.ok) {\n                                throw new Error('select failed');\n                            }\n                            return response.json();\n                        }).then(function () {\n                            window.location.href = '/simplecheckout';\n                        }).catch(function () {\n                            card.classList.remove('address-card--active');\n                            window.alert('Не удалось выбрать адрес. Попробуйте снова.');\n                        });\n                    }\n\n                    doc.addEventListener('keydown', function (event) {\n                        if (event.key === 'Escape' && searchPanel && !searchPanel.hidden) {\n                            hideSearchPanel();\n                        } else if (event.key === 'Escape' && mapWrapper && mapOpened) {\n                            hideMap();\n                        }\n                    });\n                })();\n            </script></body></html>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

var _ = templruntime.GeneratedTemplate
